skills:
  # OCR Processing Skills
  - name: image-ocr-processing
    context: Process image documents with OCR
    key_source_files:
      - crates/kreuzberg/src/ocr/processor.rs (process_image, batch_process_images)
      - crates/kreuzberg/src/ocr/mod.rs
    master_concepts:
      - OcrProcessor initialization and lifecycle
      - Single image processing
      - Batch image processing
      - Language and config management
      - Result caching integration
    step_by_step: |
      1. Create OcrProcessor with cache config
      2. Check cache for image hash
      3. If cache hit, return cached result
      4. Select optimal OCR backend
      5. Apply preprocessing if configured
      6. Execute OCR backend
      7. Parse results (hOCR, confidence, tables)
      8. Store in cache
      9. Return structured result
    skills_involved:
      - ocr-workflow-design
      - backend-selection
      - result-parsing
      - caching-strategies
    when_to_use: Processing image documents or embedded images

  - name: tesseract-backend-usage
    context: Optimize Tesseract OCR configuration
    key_source_files:
      - crates/kreuzberg/src/ocr/tesseract_backend.rs
      - crates/kreuzberg-tesseract (C bindings)
    master_concepts:
      - PSM mode selection (0-13 modes)
      - Language pack configuration
      - hOCR output format
      - Confidence score extraction
      - Performance optimization
    step_by_step: |
      1. Validate language packs installed
      2. Select appropriate PSM mode:
         - 0: OSD only
         - 3: Assume single column (default)
         - 6: Assume single uniform block
         - 11: Sparse text
         - 13: Raw line detection
      3. Configure OCR engine mode (OEM)
      4. Run Tesseract with config
      5. Collect hOCR output
      6. Parse confidence scores
      7. Extract and reconstruct tables
    skills_involved:
      - tesseract-knowledge
      - psm-mode-selection
      - configuration-tuning
      - performance-optimization
    when_to_use: Fine-tuning Tesseract for specific document types

  - name: python-ocr-backend-integration
    context: Integrate EasyOCR and PaddleOCR via Python
    key_source_files:
      - crates/kreuzberg-py/src/plugins.rs (Python OCR backend wrappers)
    master_concepts:
      - Python plugin FFI via PyO3
      - GIL management for async execution
      - Python object caching in Rust
      - Exception handling and translation
      - Async execution via tokio::task::spawn_blocking
    step_by_step: |
      1. Wrap Python OCR class
      2. Cache name and supported languages
      3. For process_image():
         a. Clone Python object reference
         b. Spawn blocking task
         c. Acquire GIL inside task
         d. Call Python method
         e. Translate exceptions to Rust errors
         f. Return structured result
      4. Handle timeouts and cancellation
    skills_involved:
      - pyo3-ffi
      - gil-management
      - async-patterns
      - exception-handling
    when_to_use: Adding Python-based OCR backends

  - name: image-preprocessing-pipeline
    context: Prepare images for optimal OCR accuracy
    key_source_files:
      - crates/kreuzberg/src/ocr/processor.rs (preprocessing logic)
    master_concepts:
      - Image format normalization
      - Resolution optimization
      - Noise reduction techniques
      - Contrast enhancement (CLAHE)
      - Deskewing algorithms
      - Binarization for specific backends
    step_by_step: |
      1. Analyze image characteristics (resolution, color, noise)
      2. Apply format normalization
      3. Adjust resolution if needed:
         - Upscale if < 150 DPI
         - Downsample if > 600 DPI
      4. Apply noise reduction:
         - Gaussian blur for high noise
         - Morphological operations
      5. Enhance contrast:
         - Histogram equalization
         - CLAHE for local contrast
      6. Correct skew/rotation
      7. Apply binarization if needed
      8. Validate preprocessing result
    skills_involved:
      - image-processing
      - cv-algorithms
      - quality-assessment
      - preprocessing-tuning
    when_to_use: Optimizing image quality before OCR

  - name: hocr-parsing-and-conversion
    context: Extract structured data from Tesseract hOCR output
    key_source_files:
      - crates/kreuzberg/src/ocr/hocr.rs
    master_concepts:
      - hOCR XML format parsing
      - Bounding box extraction
      - Confidence score tracking
      - Text formatting preservation
      - Markdown conversion
      - Integration with table reconstruction
    step_by_step: |
      1. Parse hOCR XML from Tesseract
      2. Extract word elements with:
         - Text content
         - Bounding box (x, y, width, height)
         - Confidence score
         - Language info
      3. Group words into:
         - Lines
         - Paragraphs
         - Text blocks
      4. Convert formatting:
         - Bold text
         - Italic text
         - Spacing/alignment
      5. Generate Markdown output:
         - Heading levels
         - Lists
         - Text formatting
      6. Feed positioning data to table reconstruction
    skills_involved:
      - xml-parsing
      - coordinate-systems
      - markdown-generation
      - hocr-format-knowledge
    when_to_use: Processing Tesseract hOCR output

  - name: table-extraction-and-reconstruction
    context: Identify and reconstruct tables from OCR data
    key_source_files:
      - crates/kreuzberg/src/ocr/table/mod.rs
    master_concepts:
      - Table detection from word positioning
      - Cell boundary identification
      - Spatial clustering algorithms
      - TSV format parsing
      - Markdown table generation
      - Handling complex layouts (merged cells)
    step_by_step: |
      1. Extract word positions from hOCR
      2. Perform spatial clustering:
         - Group words by vertical alignment
         - Identify column boundaries
         - Identify row boundaries
      3. Detect table cells:
         - Assign words to cells
         - Handle merged cells
         - Detect cell padding
      4. Parse TSV output if available:
         - Map cells to TSV rows/cols
         - Merge with hOCR data
      5. Convert to Markdown table:
         - Generate table header
         - Add alignment indicators
         - Handle spanning cells
         - Escape special characters
      6. Validate table structure
    skills_involved:
      - spatial-analysis
      - clustering-algorithms
      - table-structure-knowledge
      - markdown-table-format
    when_to_use: Reconstructing tables from OCR output

  - name: ocr-language-configuration
    context: Configure OCR for multiple languages
    key_source_files:
      - crates/kreuzberg/src/ocr/language_registry.rs
      - Language validation in config
    master_concepts:
      - Language pack validation
      - Multi-language support
      - Language code standardization
      - Per-document language specification
      - Language detection and fallback
    step_by_step: |
      1. Validate language packs installed
      2. Check language pack integrity
      3. Configure languages per document
      4. For multi-language documents:
         a. Specify primary language
         b. Specify secondary languages
         c. Detect language switches
      5. Select appropriate language set for OCR
      6. Handle missing language packs:
         - Suggest installation
         - Fall back to available languages
         - Use language detection if available
    skills_involved:
      - language-code-standards
      - language-pack-management
      - validation-logic
      - error-handling
    when_to_use: Handling multi-language OCR

  - name: ocr-caching-strategy
    context: Optimize OCR performance through caching
    key_source_files:
      - crates/kreuzberg/src/ocr/cache.rs
    master_concepts:
      - Content-based hash generation
      - Cache key design
      - Cache storage backends
      - Cache invalidation
      - Cache statistics and metrics
      - Hit rate optimization
    step_by_step: |
      1. Generate content hash of image
      2. Combine with:
         - OCR backend identifier
         - TesseractConfig serialization
         - Language configuration
      3. Use hash as cache key
      4. Check cache for entry
      5. Validate cache entry:
         - Matches current config
         - Integrity check
         - Age check if applicable
      6. Store result with metadata
      7. Track statistics:
         - Hit rate
         - Storage size
         - Access patterns
    skills_involved:
      - hashing-algorithms
      - cache-design
      - persistence-patterns
      - metrics-collection
    when_to_use: Optimizing OCR performance for repeated images

  - name: batch-ocr-processing
    context: Process multiple images concurrently
    key_source_files:
      - crates/kreuzberg/src/ocr/processor.rs (batch_process_images)
    master_concepts:
      - Worker pool creation
      - Concurrent image processing
      - Per-image error handling
      - Resource sharing
      - Result ordering preservation
    step_by_step: |
      1. Create OcrProcessor (shared)
      2. Estimate optimal worker count
      3. Create queue of images
      4. Spawn worker tasks
      5. Each worker:
         a. Process image from queue
         b. Handle errors independently
         c. Return results
      6. Aggregate results maintaining order
      7. Return batch results
    skills_involved:
      - concurrency-patterns
      - tokio-usage
      - error-aggregation
      - performance-tuning
    when_to_use: Processing multiple images efficiently

  - name: ocr-quality-assessment
    context: Measure and improve OCR output quality
    key_source_files:
      - OCR tests and quality metrics
    master_concepts:
      - Confidence score analysis
      - Accuracy metrics (CER, WER)
      - Quality filtering
      - Preprocessing impact measurement
      - Backend comparison
      - Language-specific quality
    step_by_step: |
      1. Run OCR on test documents
      2. Extract confidence scores
      3. Calculate accuracy metrics:
         - Character Error Rate (CER)
         - Word Error Rate (WER)
      4. Analyze confidence distribution
      5. Identify low-confidence regions
      6. Test preprocessing impact:
         - Before preprocessing
         - After preprocessing
         - Measure improvement
      7. Compare OCR backends
      8. Profile language-specific quality
    skills_involved:
      - metrics-design
      - statistical-analysis
      - ground-truth-preparation
      - performance-analysis
    when_to_use: Assessing and improving OCR quality

  - name: ocr-error-recovery
    context: Handle OCR failures gracefully
    key_source_files:
      - Error handling in ocr/processor.rs
    master_concepts:
      - Backend failure handling
      - Fallback backend selection
      - Partial result handling
      - Error context preservation
      - User notification
    step_by_step: |
      1. Attempt OCR with selected backend
      2. On error:
         a. Log error details
         b. Record backend that failed
         c. Store original image
      3. Try fallback backend if available
      4. Return best available result:
         - Full result if successful
         - Partial result if some data extracted
         - Error if complete failure
      5. Document failure for monitoring
      6. Provide recovery suggestions
    skills_involved:
      - error-handling-patterns
      - fallback-strategies
      - logging-design
      - user-experience
    when_to_use: Improving robustness to OCR failures

  - name: psmmode-tuning
    context: Select and optimize Tesseract PSM modes
    key_source_files:
      - crates/kreuzberg/src/ocr/types.rs (PSMMode enum)
    master_concepts:
      - PSM mode characteristics
      - Document layout analysis
      - Region-based mode selection
      - Mode impact on accuracy
      - Default mode optimization
    step_by_step: |
      1. Analyze document layout
      2. Identify layout characteristics:
         - Single column vs. multi-column
         - Sparse vs. dense text
         - Text direction (LTR, RTL)
      3. Select PSM mode:
         - 0: OSD only
         - 3: Default (single column)
         - 6: Single block
         - 11: Sparse text
         - 13: Raw line
      4. Test PSM mode effectiveness
      5. Document mode selection heuristics
      6. Implement adaptive mode selection
    skills_involved:
      - tesseract-knowledge
      - layout-analysis
      - heuristic-design
      - performance-tuning
    when_to_use: Optimizing Tesseract for specific document types
