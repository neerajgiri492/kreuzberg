version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

vars:
  JAVA_VERSION: "17"

tasks:
  install:
    desc: Install Java dependencies
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn clean install -DskipTests'
        platforms: [linux, darwin]
      - cmd: mvn clean install -DskipTests
        platforms: [windows]

  setup:
    desc: Setup Java environment (alias for install)
    dir: packages/java
    cmds:
      - task: java:install

  build:
    desc: Build Java package (depends on Rust FFI)
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn clean package -DskipTests'
        platforms: [linux, darwin]
      - cmd: mvn clean package -DskipTests
        platforms: [windows]

  build:dev:
    desc: Build Java package in debug mode
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn clean package -DskipTests -DdebugMode=true'
        platforms: [linux, darwin]
      - cmd: mvn clean package -DskipTests -DdebugMode=true
        platforms: [windows]

  build:release:
    desc: Build Java package in release mode (optimized)
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn clean package -DskipTests -Pproduction'
        platforms: [linux, darwin]
      - cmd: mvn clean package -DskipTests -Pproduction
        platforms: [windows]

  build:ci:
    desc: Build Java package in CI mode
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn clean package -DskipTests'
        platforms: [linux, darwin]
      - cmd: mvn clean package -DskipTests
        platforms: [windows]

  build:bindings:
    desc: Build Java bindings for benchmarking
    cmds:
      - bash scripts/benchmarks/build-java-package.sh

  test:
    desc: Run Java tests
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn test'
        platforms: [linux, darwin]
      - cmd: mvn test
        platforms: [windows]

  test:ci:
    desc: Run Java tests in CI mode
    env:
      MAVEN_OPTS: "-Xmx1024m"
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn test -B'
        platforms: [linux, darwin]
      - cmd: mvn test -B
        platforms: [windows]

  test:verbose:
    desc: Run Java tests with verbose output
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn test -X'
        platforms: [linux, darwin]
      - cmd: mvn test -X
        platforms: [windows]

  lint:
    desc: Lint Java code for code quality issues (checkstyle + PMD static analysis)
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn checkstyle:check && mvn pmd:check pmd:cpd-check'
        platforms: [linux, darwin]
      - cmd: |
          mvn checkstyle:check
          mvn pmd:check pmd:cpd-check
        platforms: [windows]

  lint:check:
    desc: Check Java code quality without modifications (checkstyle + PMD analysis)
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn checkstyle:check && mvn pmd:check pmd:cpd-check'
        platforms: [linux, darwin]
      - cmd: |
          mvn checkstyle:check
          mvn pmd:check pmd:cpd-check
        platforms: [windows]

  format:
    desc: Format Java code with automatic style corrections (spotless)
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn spotless:apply'
        platforms: [linux, darwin]
      - cmd: mvn spotless:apply
        platforms: [windows]

  format:check:
    desc: Check Java code formatting without modifications (spotless)
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn spotless:check'
        platforms: [linux, darwin]
      - cmd: mvn spotless:check
        platforms: [windows]

  clean:
    desc: Clean Java build artifacts
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn clean'
        platforms: [linux, darwin]
      - cmd: mvn clean
        platforms: [windows]

  update:
    desc: Update Java dependencies and plugins (including linters)
    dir: packages/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && echo "Updating Java dependencies and plugins..." && mvn -DallowSnapshots=false versions:use-latest-releases -DprocessDependencies=true -DprocessParent=false && echo "Updating plugin versions in properties..." && mvn -DallowSnapshots=false versions:update-properties && echo "Displaying final dependency updates..." && mvn -DallowSnapshots=false versions:display-dependency-updates && echo "Displaying final plugin updates..." && mvn -DallowSnapshots=false versions:display-plugin-updates'
        platforms: [linux, darwin]
      - cmd: |
          echo "Updating Java dependencies and plugins..."
          mvn -DallowSnapshots=false versions:use-latest-releases -DprocessDependencies=true -DprocessParent=false
          echo "Updating plugin versions in properties..."
          mvn -DallowSnapshots=false versions:update-properties
          echo "Displaying final dependency updates..."
          mvn -DallowSnapshots=false versions:display-dependency-updates
          echo "Displaying final plugin updates..."
          mvn -DallowSnapshots=false versions:display-plugin-updates
        platforms: [windows]

  e2e:generate:
    desc: Generate Java E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh java
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]

  e2e:lint:
    desc: Lint Java E2E code
    dir: e2e/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn checkstyle:check && mvn pmd:check pmd:cpd-check'
        platforms: [linux, darwin]
      - cmd: |
          mvn checkstyle:check
          mvn pmd:check pmd:cpd-check
        platforms: [windows]

  e2e:test:
    desc: Run Java E2E tests
    dir: e2e/java
    cmds:
      - cmd: bash -c 'source ~/.sdkman/bin/sdkman-init.sh && sdk use java 25.0.1-tem && sdk use maven 3.9.11 && mvn -B -DtrimStackTrace=false -Dsurefire.useFile=false test'
        platforms: [linux, darwin]
      - cmd: mvn -B -DtrimStackTrace=false -Dsurefire.useFile=false test
        platforms: [windows]

  e2e:verify:
    desc: Regenerate and validate Java E2E suite (build + generate + lint + test)
    cmds:
      - task: build
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
