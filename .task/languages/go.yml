version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

vars:
  GO_VERSION: "1.22"

tasks:
  install:
    desc: Install Go tools and modules
    cmds:
      - scripts/go/install.sh {{.GOLANGCI_LINT_VERSION}}

  setup:
    desc: Setup Go tools and modules (alias for install)
    cmds:
      - task: go:install

  build:
    desc: Build Go bindings (requires Rust FFI to be built first)
    dir: packages/go/v4
    env:
      CGO_ENABLED: "1"
    cmds:
      - go build ./...

  build:dev:
    desc: Build Go bindings in debug mode (requires Rust FFI to be built first)
    dir: packages/go/v4
    env:
      CGO_ENABLED: "1"
    cmds:
      - go build ./...

  build:release:
    desc: Build Go bindings in release mode (optimized, requires Rust FFI to be built first)
    dir: packages/go/v4
    env:
      CGO_ENABLED: "1"
    cmds:
      - go build -ldflags="-s -w" ./...

  build:ci:
    desc: Build Go bindings in CI mode (requires Rust FFI to be built first)
    dir: packages/go/v4
    env:
      CGO_ENABLED: "1"
    cmds:
      - go build ./...

  build:bindings:
    desc: Build Go bindings for benchmarking
    cmds:
      - bash scripts/benchmarks/build-go-bindings.sh

  test:
    desc: Run Go tests
    cmds:
      - scripts/go/test.sh

  test:ci:
    desc: Run Go tests in CI mode
    env:
      RUST_BACKTRACE: "1"
    cmds:
      - scripts/go/test.sh

  test:verbose:
    desc: Run Go tests with verbose output
    dir: packages/go/v4
    cmds:
      - go test -v ./...

  lint:
    desc: Lint and format Go code with auto-fix (golangci-lint + gofmt)
    cmds:
      - cmd: bash scripts/task/go-lint.sh fix
        platforms: [linux, darwin]
      - cmd: pwsh scripts/task/go-lint.ps1 -Mode fix
        platforms: [windows]

  lint:check:
    desc: Lint and format Go code in check-only mode (golangci-lint + gofmt, no fixes)
    cmds:
      - cmd: bash scripts/task/go-lint.sh check
        platforms: [linux, darwin]
      - cmd: pwsh scripts/task/go-lint.ps1 -Mode check
        platforms: [windows]

  format:
    desc: Format Go code with modifications (gofmt)
    dir: packages/go/v4
    cmds:
      - gofmt -w .

  format:check:
    desc: Check Go code formatting without modifications (gofmt)
    dir: packages/go/v4
    cmds:
      - scripts/go/format_check.sh

  clean:
    desc: Clean Go build artifacts
    dir: packages/go/v4
    cmds:
      - go clean
      - python -c "import shutil; shutil.rmtree('bin', ignore_errors=True)"

  update:
    desc: Update Go dependencies and linters
    cmds:
      - echo "Updating Go dependencies and linters..."
      - scripts/go/update.sh {{.GOLANGCI_LINT_VERSION}}

  e2e:generate:
    desc: Generate Go E2E tests from fixtures
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh go
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]
      - cmd: scripts/e2e/go/format.sh
        platforms: [linux, darwin]

  e2e:lint:
    desc: Lint Go E2E code
    cmds:
      - cmd: bash scripts/task/go-lint.sh check
        platforms: [linux, darwin]
      - cmd: pwsh scripts/task/go-lint.ps1 -Mode check
        platforms: [windows]

  e2e:test:
    desc: Run Go E2E tests
    cmds:
      - scripts/e2e/go/test.sh

  e2e:verify:
    desc: Regenerate and validate Go E2E suite (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
