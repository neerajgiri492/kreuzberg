version: "3"

vars:
  EXE_EXT:
    sh: |
      os="{{.OS}}"

      # Direct OS detection
      if [ "$os" = "windows" ]; then
        echo ".exe"
        exit 0
      fi

      # Windows environment indicators
      if [ -n "$WINDIR" ] || [ -n "$SYSTEMROOT" ]; then
        echo ".exe"
        exit 0
      fi

      # Git Bash/MSYS2/MinGW indicators
      if [ -n "$MSYSTEM" ]; then
        echo ".exe"
        exit 0
      fi

      # Check for Windows via PowerShell if available
      if command -v powershell &>/dev/null; then
        os_env=$(powershell -NoProfile -Command '$env:OS' 2>/dev/null || echo "")
        if [ -n "$os_env" ] && echo "$os_env" | grep -qi windows; then
          echo ".exe"
          exit 0
        fi
      fi

      # Unix-like systems have no extension
      echo ""

  LIB_EXT:
    sh: |
      os="{{.OS}}"
      case "$os" in
        darwin)
          echo "dylib"
          ;;
        linux|freebsd|openbsd|netbsd)
          echo "so"
          ;;
        windows|mingw*|msys*)
          echo "dll"
          ;;
        *)
          echo "so"
          ;;
      esac

  NUM_CPUS:
    sh: |
      os="{{.OS}}"

      # Try Windows PowerShell first
      if [ "$os" = "windows" ]; then
        if command -v powershell &>/dev/null; then
          num=$(powershell -NoProfile -Command '$([System.Environment]::ProcessorCount)' 2>/dev/null || echo "")
          if [ -n "$num" ] && [ "$num" -gt 0 ]; then
            echo "$num"
            exit 0
          fi
        fi

        # Try environment variable for Windows
        if [ -n "$NUMBER_OF_PROCESSORS" ]; then
          echo "$NUMBER_OF_PROCESSORS"
          exit 0
        fi
      fi

      # macOS
      if [ "$os" = "darwin" ]; then
        sysctl -n hw.ncpu 2>/dev/null || echo 4
        exit 0
      fi

      # Linux and other Unix-like systems
      if command -v nproc &>/dev/null; then
        nproc 2>/dev/null || echo 4
        exit 0
      fi

      # Fallback for Linux if nproc is not available
      if [ -f /proc/cpuinfo ]; then
        grep -c '^processor' /proc/cpuinfo 2>/dev/null || echo 4
        exit 0
      fi

      # Fallback to sysctl for other systems
      if command -v sysctl &>/dev/null; then
        sysctl -n hw.ncpu 2>/dev/null || echo 4
        exit 0
      fi

      # Ultimate fallback
      echo 4
